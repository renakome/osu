name: Build Android (signed debug) and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x' # ajuste conforme necessário

    - name: Free up disk space
      run: |
        echo "Disk space before cleanup:"
        df -h

        # Remove unnecessary packages and clear package cache
        sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' '^php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri
        sudo apt-get autoremove -y
        sudo apt-get clean

        # Clear package manager cache
        sudo rm -rf /var/lib/apt/lists/*

        # Remove old .NET SDKs and caches
        rm -rf ~/.dotnet
        rm -rf ~/.nuget

        echo "Disk space after cleanup:"
        df -h

    - name: Install .NET Android workload
      run: |
        dotnet workload install android --include-previews || true
        dotnet workload restore || true

        # Accept Android SDK licenses to avoid warnings
        yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses || true

    - name: Restore
      run: dotnet restore osu.Android.slnf

    - name: Build Release (Android)
      run: |
        echo "Disk space before build:"
        df -h

        dotnet build osu.Android.slnf -c Release -v minimal

        echo "Disk space after build:"
        df -h

        # Clean up build artifacts to free space
        rm -rf obj/
        echo "Disk space after cleanup:"
        df -h

    - name: Find produced APK(s)
      id: find_apks
      run: |
        set -e
        # procura apks comuns na pasta bin/Release (ajuste se seu output muda)
        apks=$(find . -type f -path "*/bin/Release/*/*.apk" -o -path "*/bin/Release/**/*.apk" || true)
        if [ -z "$apks" ]; then
          echo "No APKs found in bin/Release. Listing tree for debug:"
          ls -R || true
          exit 1
        fi
        echo "$apks"
        echo "apk_files<<EOF" >> $GITHUB_OUTPUT
        echo "$apks" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Prepare debug keystore
      run: |
        # Usa secret DEBUG_KEYSTORE_BASE64 se existir (recomendado para chave persistente)
        if [ -n "${{ secrets.DEBUG_KEYSTORE_BASE64 }}" ]; then
          echo "Using provided DEBUG_KEYSTORE_BASE64 secret..."
          echo "${{ secrets.DEBUG_KEYSTORE_BASE64 }}" | base64 -d > debug.keystore
        else
          echo "No DEBUG_KEYSTORE_BASE64 secret found — generating debug.keystore on-the-fly..."
          keytool -genkeypair -v \
            -keystore debug.keystore \
            -storepass android -keypass android \
            -alias androiddebugkey \
            -dname "CN=Android Debug,O=Android,C=US" \
            -keyalg RSA -keysize 2048 -validity 10000
        fi
        ls -lah debug.keystore

    - name: Download uber-apk-signer
      run: |
        wget -q https://github.com/patrickfav/uber-apk-signer/releases/download/v1.2.1/uber-apk-signer-1.2.1.jar -O uber-apk-signer.jar
        java -version || true

    - name: Sign APK(s) with debug keystore
      run: |
        IFS=$'\n'
        for apk in ${{ steps.find_apks.outputs.apk_files }}; do
          echo "Signing: $apk"
          java -jar uber-apk-signer.jar --apks "$apk" \
            --ks debug.keystore --ks-key-alias androiddebugkey \
            --ks-pass pass:android --key-pass pass:android \
            --allowResign
        done
      shell: bash

    - name: Collect signed APKs
      id: collect_signed
      run: |
        signed=$(find . -type f -name "*aligned.apk" -o -path "*/signed/*.apk" || true)
        if [ -z "$signed" ]; then
          echo "No signed APKs found. Listing files for debug:"
          ls -R || true
          exit 1
        fi
        echo "$signed"
        echo "signed_apks<<EOF" >> $GITHUB_OUTPUT
        echo "$signed" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release and upload signed APK(s)
      uses: ncipollo/release-action@v1
      with:
        tag: android-build-${{ github.run_number }}-r${{ github.run_id }}
        name: Android build ${{ github.run_number }} (run ${{ github.run_id }})
        body: Automated Android build (signed debug) from Actions.
        draft: false
        prerelease: true
        artifacts: "**/signed/*.apk,**/*aligned.apk"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Final cleanup
      if: always()
      run: |
        echo "Final disk space check:"
        df -h

        # Remove debug keystore and signing tools
        rm -f debug.keystore uber-apk-signer.jar

        # Remove any remaining build artifacts
        find . -name "*.tmp" -type f -delete
        find . -name "*.log" -type f -delete

        echo "Final disk space after cleanup:"
        df -h
